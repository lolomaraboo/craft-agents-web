---
phase: 02-core-api
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/server/routes/api/index.ts
  - apps/web/src/server/routes/api/workspaces.ts
  - apps/web/src/server/routes/api/config.ts
  - apps/web/src/server/routes/api/mcp.ts
  - apps/web/src/server/routes/api/theme.ts
  - apps/web/src/server/schemas/workspace.ts
  - apps/web/src/server/schemas/config.ts
  - apps/web/src/server/schemas/mcp.ts
  - apps/web/src/server/schemas/theme.ts
autonomous: true

must_haves:
  truths:
    - "User can list workspaces via GET /api/workspaces"
    - "User can create a workspace via POST /api/workspaces"
    - "User can get workspace settings via GET /api/workspaces/:id/settings"
    - "User can update workspace settings via PATCH /api/workspaces/:id/settings"
    - "User can get global config via GET /api/config"
    - "User can update global config via PATCH /api/config"
    - "User can list MCP connections via GET /api/workspaces/:id/mcp"
    - "User can get theme via GET /api/theme"
  artifacts:
    - path: "apps/web/src/server/routes/api/workspaces.ts"
      provides: "Workspace REST endpoints"
      exports: ["workspacesRoutes"]
    - path: "apps/web/src/server/routes/api/config.ts"
      provides: "Global config endpoints"
      exports: ["configRoutes"]
    - path: "apps/web/src/server/routes/api/mcp.ts"
      provides: "MCP server management endpoints"
      exports: ["mcpRoutes"]
    - path: "apps/web/src/server/routes/api/theme.ts"
      provides: "Theme endpoints"
      exports: ["themeRoutes"]
  key_links:
    - from: "apps/web/src/server/routes/api/workspaces.ts"
      to: "@craft-agent/shared/config"
      via: "direct import"
      pattern: "from '@craft-agent/shared/config'"
    - from: "apps/web/src/server/routes/api/index.ts"
      to: "workspaces, config, mcp, theme routes"
      via: "route plugin registration"
      pattern: "register.*(workspaces|config|mcp|theme)Routes"
---

<objective>
Implement workspace, config, MCP, and theme endpoints for the web API layer.

Purpose: Replace Electron IPC handlers for workspace management (GET_WORKSPACES, CREATE_WORKSPACE, WORKSPACE_SETTINGS_*), configuration (SETTINGS_*, PREFERENCES_*), MCP servers (SOURCES_GET_MCP_TOOLS), and theming (THEME_*) with HTTP REST endpoints.

Output: Fastify route plugins with TypeBox-validated endpoints for workspace, config, MCP, and theme management, using the existing @craft-agent/shared utilities.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-api/02-RESEARCH.md
@.planning/phases/01-server-foundation/01-01-SUMMARY.md
@apps/web/src/server/index.ts
@apps/electron/src/shared/types.ts (IPC_CHANNELS, WorkspaceSettings)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create workspace routes and schemas</name>
  <files>apps/web/src/server/schemas/workspace.ts, apps/web/src/server/routes/api/workspaces.ts</files>
  <action>
Create workspace schemas at apps/web/src/server/schemas/workspace.ts:
- WorkspaceSchema: { id: string, name: string, rootPath: string }
- CreateWorkspaceSchema: { folderPath: string, name: string }
- WorkspaceSettingsSchema: { name?: string, model?: string, permissionMode?: string, thinkingLevel?: string, workingDirectory?: string, localMcpEnabled?: boolean, cyclablePermissionModes?: string[] }
- UpdateWorkspaceSettingsSchema: Partial of WorkspaceSettingsSchema

Create workspace routes at apps/web/src/server/routes/api/workspaces.ts:
- Use FastifyPluginAsync
- Endpoints:
  - GET /workspaces - List all workspaces (uses getWorkspaces from @craft-agent/shared/config)
  - POST /workspaces - Create workspace (body: CreateWorkspaceSchema, uses addWorkspace)
  - GET /workspaces/:id - Get workspace details
  - GET /workspaces/:id/settings - Get workspace settings
  - PATCH /workspaces/:id/settings - Update workspace settings (partial update)
  - GET /workspaces/:id/sources - List sources for workspace (placeholder - uses loadWorkspaceSources)
  - GET /workspaces/:id/skills - List skills for workspace (placeholder)
  - GET /workspaces/:id/labels - List labels for workspace (placeholder)
  - GET /workspaces/:id/statuses - List statuses for workspace (placeholder)

Import workspace functions directly from @craft-agent/shared/config:
- getWorkspaces, getWorkspaceByNameOrId, addWorkspace, setActiveWorkspace
- These are the same functions used by Electron IPC handlers

Note: Sources, skills, labels, statuses endpoints return empty arrays for now - full implementation comes when we need them for the frontend.
  </action>
  <verify>
```bash
cd /opt/craft-agents-web && bun run tsc --noEmit -p apps/web/tsconfig.json
```
TypeScript compiles without errors.
  </verify>
  <done>Workspace routes and schemas created. Uses @craft-agent/shared/config directly.</done>
</task>

<task type="auto">
  <name>Task 2: Create config, MCP, and theme routes</name>
  <files>apps/web/src/server/schemas/config.ts, apps/web/src/server/schemas/mcp.ts, apps/web/src/server/schemas/theme.ts, apps/web/src/server/routes/api/config.ts, apps/web/src/server/routes/api/mcp.ts, apps/web/src/server/routes/api/theme.ts</files>
  <action>
Create config schemas at apps/web/src/server/schemas/config.ts:
- ApiSetupSchema: { authType: string, hasCredential: boolean, apiKey?: string, anthropicBaseUrl?: string, customModel?: string }
- UpdateApiSetupSchema: { authType: string, credential?: string, anthropicBaseUrl?: string, customModel?: string }
- ModelSchema: { model: string | null }

Create config routes at apps/web/src/server/routes/api/config.ts:
- GET /config/api-setup - Get API setup info (getAuthType, getAnthropicBaseUrl, getCustomModel)
- PATCH /config/api-setup - Update API setup (setAuthType, setAnthropicBaseUrl, setCustomModel)
- GET /config/model - Get global model setting
- PATCH /config/model - Set global model
- GET /config/preferences - Read user preferences file
- PUT /config/preferences - Write user preferences file

Import from @craft-agent/shared/config:
- getAuthType, setAuthType, getAnthropicBaseUrl, setAnthropicBaseUrl
- getCustomModel, setCustomModel, getModel, setModel
- getPreferencesPath (for preferences file operations)

Create MCP schemas at apps/web/src/server/schemas/mcp.ts:
- McpToolSchema: { name: string, description?: string, allowed: boolean }
- McpToolsResultSchema: { success: boolean, error?: string, tools?: McpToolSchema[] }

Create MCP routes at apps/web/src/server/routes/api/mcp.ts:
- GET /workspaces/:workspaceId/mcp/:sourceSlug/tools - Get MCP tools for a source
- For now, return stub data - actual MCP connection requires the source loading infrastructure

Create theme schemas at apps/web/src/server/schemas/theme.ts:
- ThemeOverridesSchema: Match ThemeOverrides from @config/theme
- ColorThemeSchema: { themeId: string }

Create theme routes at apps/web/src/server/routes/api/theme.ts:
- GET /theme - Get app-level theme
- GET /theme/color - Get current color theme ID
- PUT /theme/color - Set color theme ID
- GET /theme/system - Get system theme preference (dark mode)
- GET /theme/presets - List preset themes

Import from workspace theme config or use stubs for now.
  </action>
  <verify>
```bash
cd /opt/craft-agents-web && bun run tsc --noEmit -p apps/web/tsconfig.json
```
TypeScript compiles without errors.
  </verify>
  <done>Config, MCP, and theme routes created with appropriate schemas.</done>
</task>

<task type="auto">
  <name>Task 3: Register all routes in API plugin</name>
  <files>apps/web/src/server/routes/api/index.ts</files>
  <action>
Update apps/web/src/server/routes/api/index.ts to register all route plugins:

```typescript
import fp from 'fastify-plugin'
import { FastifyPluginAsync } from 'fastify'
import { sessionsRoutes } from './sessions.js'
import { workspacesRoutes } from './workspaces.js'
import { configRoutes } from './config.js'
import { mcpRoutes } from './mcp.js'
import { themeRoutes } from './theme.js'
import { SessionManager } from '../../lib/session-manager.js'

// Type augmentation for fastify decorators
declare module 'fastify' {
  interface FastifyInstance {
    sessionManager: SessionManager
  }
}

const apiRoutesPlugin: FastifyPluginAsync = async (fastify) => {
  // Decorate with SessionManager instance
  const sessionManager = new SessionManager()
  fastify.decorate('sessionManager', sessionManager)

  // Register all API routes under /api prefix
  await fastify.register(sessionsRoutes, { prefix: '/api' })
  await fastify.register(workspacesRoutes, { prefix: '/api' })
  await fastify.register(configRoutes, { prefix: '/api' })
  await fastify.register(mcpRoutes, { prefix: '/api' })
  await fastify.register(themeRoutes, { prefix: '/api' })
}

export const apiRoutes = fp(apiRoutesPlugin, {
  name: 'api-routes',
  fastify: '5.x'
})
```

Ensure apps/web/src/server/index.ts imports and registers apiRoutes:
```typescript
import { apiRoutes } from './routes/api/index.js'
// ... in createServer
await fastify.register(apiRoutes)
```
  </action>
  <verify>
Start the dev server and test all endpoint groups:
```bash
cd /opt/craft-agents-web && bun run web:dev &
sleep 3

# Workspaces
curl http://localhost:3000/api/workspaces
curl -X POST http://localhost:3000/api/workspaces -H "Content-Type: application/json" -d '{"folderPath": "/tmp/test", "name": "Test"}'

# Config
curl http://localhost:3000/api/config/api-setup
curl http://localhost:3000/api/config/model

# Theme
curl http://localhost:3000/api/theme
curl http://localhost:3000/api/theme/color

# MCP (returns stub/empty)
curl http://localhost:3000/api/workspaces/test/mcp/test-source/tools
```
All endpoints respond with appropriate status codes.
  </verify>
  <done>All API routes registered and responding. Full API layer complete.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `bun run tsc --noEmit -p apps/web/tsconfig.json`
2. Server starts: `bun run web:dev` shows server listening
3. GET /api/workspaces returns 200 with array (may be empty initially)
4. POST /api/workspaces creates workspace
5. GET /api/workspaces/:id/settings returns settings or 404
6. PATCH /api/workspaces/:id/settings updates settings
7. GET /api/config/api-setup returns API config
8. PATCH /api/config/api-setup updates config
9. GET /api/theme returns theme data
10. PUT /api/theme/color sets color theme
</verification>

<success_criteria>
- Workspace CRUD endpoints functional (API-04)
- Config get/update endpoints functional (API-05)
- Credential endpoints exist (API-06, server-side only for now)
- MCP endpoints exist with stubs (API-07)
- Theme endpoints functional (API-08)
- TypeBox validation on all endpoints
- All routes properly prefixed under /api
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-api/02-02-SUMMARY.md`
</output>
