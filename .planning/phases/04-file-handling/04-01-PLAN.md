---
phase: 04-file-handling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/package.json
  - apps/web/src/server/plugins/multipart.ts
  - apps/web/src/server/schemas/attachment.ts
  - apps/web/src/server/lib/file-validator.ts
  - apps/web/src/server/routes/api/attachments.ts
  - apps/web/src/server/routes/api/index.ts
  - apps/web/src/server/index.ts
autonomous: true

must_haves:
  truths:
    - "User can upload files via POST /api/sessions/:id/attachments"
    - "Uploaded files are stored in session attachments directory"
    - "File type is validated using magic numbers, not just extension"
    - "Upload response returns attachment metadata with storedPath"
  artifacts:
    - path: "apps/web/src/server/plugins/multipart.ts"
      provides: "@fastify/multipart plugin configuration"
      exports: ["multipartPlugin"]
    - path: "apps/web/src/server/schemas/attachment.ts"
      provides: "TypeBox schemas for attachment upload/response"
      exports: ["AttachmentSchema", "UploadResponseSchema"]
    - path: "apps/web/src/server/lib/file-validator.ts"
      provides: "Magic number validation for uploaded files"
      exports: ["validateFileUpload", "ALLOWED_TYPES"]
    - path: "apps/web/src/server/routes/api/attachments.ts"
      provides: "Upload endpoint for session attachments"
      exports: ["attachmentsRoutes"]
  key_links:
    - from: "apps/web/src/server/routes/api/attachments.ts"
      to: "@craft-agent/shared/sessions/storage"
      via: "getSessionAttachmentsPath, ensureAttachmentsDir"
      pattern: "getSessionAttachmentsPath|ensureAttachmentsDir"
    - from: "apps/web/src/server/routes/api/attachments.ts"
      to: "apps/web/src/server/lib/file-validator.ts"
      via: "validateFileUpload import"
      pattern: "validateFileUpload"
    - from: "apps/web/src/server/routes/api/index.ts"
      to: "apps/web/src/server/routes/api/attachments.ts"
      via: "route registration"
      pattern: "attachmentsRoutes"
---

<objective>
Implement file upload endpoint with multipart form handling, magic number validation, and session-scoped storage.

Purpose: Enable browser users to upload file attachments that get stored in session directories, matching Electron app behavior.

Output: Working POST /api/sessions/:id/attachments endpoint that accepts multipart file uploads and returns StoredAttachment metadata.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-file-handling/04-RESEARCH.md

# Existing patterns
@apps/web/src/server/routes/api/sessions.ts
@apps/web/src/server/routes/api/index.ts
@apps/web/src/server/plugins/cors.ts
@apps/web/src/server/schemas/session.ts

# Shared package utilities for attachment storage
@packages/shared/src/sessions/storage.ts (getSessionAttachmentsPath, ensureAttachmentsDir)
@packages/shared/src/utils/files.ts (FileAttachment interface)
@packages/core/src/types/message.ts (StoredAttachment interface)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create multipart plugin</name>
  <files>
    apps/web/package.json
    apps/web/src/server/plugins/multipart.ts
    apps/web/src/server/index.ts
  </files>
  <action>
1. Install required dependencies:
   ```bash
   cd apps/web && bun add @fastify/multipart file-type
   ```

2. Create `apps/web/src/server/plugins/multipart.ts`:
   - Export `multipartPlugin` using fastify-plugin wrapper (follow cors.ts pattern)
   - Configure @fastify/multipart with limits:
     - fileSize: 20 * 1024 * 1024 (20MB, matches Electron app limit)
     - files: 10 (max 10 files per request)
   - Use attachFieldsToBody: false (we'll use request.parts() async iterator)

3. Register multipart plugin in `apps/web/src/server/index.ts`:
   - Import and register BEFORE api routes (multipart must be registered first)
   - Add after CORS plugin, before API routes

Reference RESEARCH.md Pattern 1 for multipart configuration.
  </action>
  <verify>
    - `bun run typecheck` passes in apps/web
    - Server starts with `cd apps/web && bun run dev`
    - No errors in console about multipart plugin
  </verify>
  <done>
    - @fastify/multipart v9.x and file-type v19.x installed
    - Multipart plugin registered with 20MB file size limit
    - Server starts successfully with plugin loaded
  </done>
</task>

<task type="auto">
  <name>Task 2: Create file validation utility and attachment schemas</name>
  <files>
    apps/web/src/server/lib/file-validator.ts
    apps/web/src/server/schemas/attachment.ts
  </files>
  <action>
1. Create `apps/web/src/server/lib/file-validator.ts`:
   - Import `fileTypeFromBuffer` from 'file-type' (ESM import)
   - Define ALLOWED_TYPES map: mime type -> attachment type
     - image/png, image/jpeg, image/gif, image/webp -> 'image'
     - application/pdf -> 'pdf'
     - text/plain, text/markdown, application/json -> 'text'
     - application/vnd.openxmlformats-officedocument.* -> 'office'
   - Export async function `validateFileUpload(buffer: Buffer, originalFilename: string)`:
     - Check buffer.length against MAX_SIZE (20MB)
     - Use fileTypeFromBuffer to detect actual file type from magic numbers
     - If no magic number detected, check extension for text files (.txt, .md, .json, .ts, .js)
     - Return { valid: true, type, mimeType } or { valid: false, error }

2. Create `apps/web/src/server/schemas/attachment.ts`:
   - Follow existing TypeBox patterns from schemas/session.ts
   - Define AttachmentTypeSchema: Type.Union of literals ('image', 'text', 'pdf', 'office', 'unknown')
   - Define StoredAttachmentSchema matching @craft-agent/core StoredAttachment interface:
     - id: Type.String()
     - type: AttachmentTypeSchema
     - name: Type.String()
     - mimeType: Type.String()
     - size: Type.Number()
     - storedPath: Type.String()
     - markdownPath: Type.Optional(Type.String())
   - Define UploadResponseSchema: Type.Object({ attachments: Type.Array(StoredAttachmentSchema) })
   - Export Static types for each schema

Reference RESEARCH.md "File Upload Validation" code example.
  </action>
  <verify>
    - `bun run typecheck` passes
    - Schemas export correctly with Static types
  </verify>
  <done>
    - File validator detects actual file type using magic numbers
    - ALLOWED_TYPES whitelist prevents malicious file uploads
    - TypeBox schemas match StoredAttachment interface from @craft-agent/core
  </done>
</task>

<task type="auto">
  <name>Task 3: Create upload route and wire to API aggregator</name>
  <files>
    apps/web/src/server/routes/api/attachments.ts
    apps/web/src/server/routes/api/index.ts
  </files>
  <action>
1. Create `apps/web/src/server/routes/api/attachments.ts`:
   - Follow sessions.ts pattern with FastifyPluginAsync and TypeBoxTypeProvider
   - Import from @craft-agent/shared/sessions/storage:
     - getSessionAttachmentsPath
     - ensureAttachmentsDir
   - Import validateFileUpload from lib/file-validator
   - Import schemas from schemas/attachment
   - Import path utilities: join, extname
   - Import fs/promises: writeFile
   - Import crypto: randomUUID for attachment IDs

   POST /sessions/:sessionId/attachments endpoint:
   - Schema: params { sessionId: string }, response { 200: UploadResponseSchema, 400, 500: ErrorResponseSchema }
   - Get parts from request.parts() async iterator
   - For each file part:
     a. Convert to buffer: `const buffer = await part.toBuffer()`
     b. Validate with validateFileUpload(buffer, part.filename)
     c. If invalid, throw 400 error with validation message
     d. Generate attachment ID with randomUUID()
     e. Create filename: `${attachmentId}-${part.filename}`
     f. Get attachments dir: ensureAttachmentsDir(workspaceRootPath, sessionId)
     g. Write file: writeFile(join(attachmentsDir, filename), buffer)
     h. Build StoredAttachment object with storedPath
   - Return { attachments: [...] }

   For workspaceRootPath: Use same pattern as existing routes - either from session lookup or hardcoded to ~/.craft-agent for Phase 4 (this can be refined when workspace context is fully wired).

2. Update `apps/web/src/server/routes/api/index.ts`:
   - Import attachmentsRoutes from './attachments.js'
   - Register with: `await fastify.register(attachmentsRoutes, { prefix: '/api' })`
   - Add after sessions routes (attachment routes extend session functionality)

Reference RESEARCH.md Pattern 1 (multipart upload with stream processing).
  </action>
  <verify>
    - `bun run typecheck` passes
    - Server starts without errors
    - Test upload with curl:
      ```bash
      echo "test content" > /tmp/test.txt
      curl -X POST http://localhost:3000/api/sessions/test-session/attachments \
        -F "files=@/tmp/test.txt" -v
      ```
    - Response includes attachments array with storedPath
  </verify>
  <done>
    - POST /api/sessions/:sessionId/attachments accepts multipart uploads
    - Files validated using magic number detection
    - Files stored in session attachments directory with unique ID prefix
    - Response returns StoredAttachment metadata including storedPath
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Server starts: `cd apps/web && bun run dev`
2. TypeCheck passes: `bun run typecheck`
3. Upload test file:
   ```bash
   echo "test file content" > /tmp/test.txt
   curl -X POST http://localhost:3000/api/sessions/test-session/attachments \
     -F "files=@/tmp/test.txt"
   ```
4. Verify response contains attachments array with id, type, name, mimeType, size, storedPath
5. Verify file exists at storedPath location
</verification>

<success_criteria>
- @fastify/multipart and file-type dependencies installed
- Multipart plugin registered with 20MB limit
- File validator uses magic numbers (not just extension)
- Upload endpoint returns StoredAttachment metadata
- Files stored in session attachments directory
- TypeBox schemas match @craft-agent/core types
</success_criteria>

<output>
After completion, create `.planning/phases/04-file-handling/04-01-SUMMARY.md`
</output>
