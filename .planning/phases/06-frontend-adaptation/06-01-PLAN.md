---
phase: 06-frontend-adaptation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/client/adapters/http-adapter.ts
  - apps/web/src/client/adapters/websocket-manager.ts
  - apps/web/src/client/adapters/index.ts
  - apps/web/src/client/types/electron-api.ts
  - apps/web/src/client/types/index.ts
autonomous: true

must_haves:
  truths:
    - "HttpAdapter implements core ElectronAPI methods via fetch calls"
    - "WebSocketManager connects to /ws and routes events to callbacks"
    - "WebSocketManager auto-reconnects with exponential backoff after disconnect"
    - "Session subscription/unsubscription messages are sent via WebSocket"
  artifacts:
    - path: "apps/web/src/client/adapters/http-adapter.ts"
      provides: "ElectronAPI implementation via HTTP"
      exports: ["HttpAdapter"]
    - path: "apps/web/src/client/adapters/websocket-manager.ts"
      provides: "WebSocket connection management and event routing"
      exports: ["WebSocketManager"]
    - path: "apps/web/src/client/types/electron-api.ts"
      provides: "Subset of ElectronAPI interface for web"
      exports: ["WebElectronAPI"]
  key_links:
    - from: "apps/web/src/client/adapters/http-adapter.ts"
      to: "/api/sessions"
      via: "fetch calls"
      pattern: "fetch.*api/sessions"
    - from: "apps/web/src/client/adapters/websocket-manager.ts"
      to: "/ws"
      via: "WebSocket connection"
      pattern: "new WebSocket.*ws"
---

<objective>
Create HTTP client adapter and WebSocket manager as the transport layer for the web frontend.

Purpose: Replace Electron's synchronous IPC with HTTP fetch calls and WebSocket event subscriptions, enabling the React frontend to communicate with the Fastify server built in Phases 1-5.

Output: HttpAdapter class implementing core ElectronAPI methods, WebSocketManager handling real-time events with auto-reconnection.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-frontend-adaptation/06-RESEARCH.md

# Server API routes (what adapter calls)
@apps/web/src/server/routes/api/sessions.ts
@apps/web/src/server/routes/api/workspaces.ts
@apps/web/src/server/routes/api/config.ts
@apps/web/src/server/routes/api/theme.ts

# WebSocket schemas (event types)
@apps/web/src/server/schemas/websocket.ts

# Electron API interface (what to implement)
@apps/electron/src/shared/types.ts (lines 704-949)

# Existing playground mock pattern
@apps/electron/src/renderer/playground/mock-utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WebElectronAPI types and WebSocketManager</name>
  <files>
    apps/web/src/client/types/electron-api.ts
    apps/web/src/client/types/index.ts
    apps/web/src/client/adapters/websocket-manager.ts
  </files>
  <action>
Create the type definitions and WebSocket manager:

1. **apps/web/src/client/types/electron-api.ts** - Subset of ElectronAPI for web:
   - Import types from @craft-agent/core/types (Session, Workspace, SessionMetadata, StoredAttachment)
   - Define SessionEvent type matching server schemas (text_delta, text_complete, tool_start, tool_result, complete, error, permission_request, permission_timeout, config_changed)
   - Define WebElectronAPI interface with methods that have HTTP equivalents:
     - Session: getSessions, getSessionMessages, createSession, deleteSession, sendMessage, cancelProcessing, respondToPermission
     - Workspace: getWorkspaces, createWorkspace
     - Config: getApiSetup, updateApiSetup, getModel, setModel, readPreferences, writePreferences
     - Theme: getColorTheme, setColorTheme, loadPresetThemes, getAppTheme
     - Events: onSessionEvent (returns cleanup function)
   - Exclude Electron-only methods: file dialogs, window management, auto-update, menu actions, shell operations, notifications

2. **apps/web/src/client/types/index.ts** - Barrel export:
   - Re-export all types from electron-api.ts
   - Export type { WebElectronAPI, SessionEvent }

3. **apps/web/src/client/adapters/websocket-manager.ts** - WebSocket connection manager:
   - Class WebSocketManager with:
     - Private ws: WebSocket | null
     - Private callbacks: Set<(event: SessionEvent) => void>
     - Private subscribedSessions: Set<string>
     - Private reconnectAttempts = 0, maxReconnectAttempts = 5, reconnectDelay = 1000
   - connect(): void - Create WebSocket to `${protocol}//${window.location.host}/ws`
     - onopen: Log connected, reset reconnectAttempts, re-subscribe to all sessions in subscribedSessions
     - onmessage: Parse JSON, iterate callbacks and call each with event
     - onclose: Log disconnected, call attemptReconnect()
     - onerror: Log error
   - attemptReconnect(): void - Exponential backoff (delay * 2^(attempts-1)), max 5 attempts
   - subscribe(callback): () => void - Add to callbacks set, connect if not connected, return cleanup
   - subscribeToSession(sessionId): void - Add to subscribedSessions, send { type: 'subscribe', sessionId }
   - unsubscribeFromSession(sessionId): void - Remove from set, send { type: 'unsubscribe', sessionId }
   - respondToPermission(requestId, allowed, alwaysAllow?): void - Send { type: 'permission_response', requestId, allowed, alwaysAllow }
   - sendMessage(message): void - Check readyState, send JSON.stringify(message)
   - disconnect(): void - Close and null ws

Export: export class WebSocketManager
  </action>
  <verify>
Run `bun run typecheck 2>&1 | grep -E "^apps/web"` - No type errors in web app.
Check files exist: `ls apps/web/src/client/types/ apps/web/src/client/adapters/`
  </verify>
  <done>WebElectronAPI type defined with subset of methods, WebSocketManager class handles connection with auto-reconnect and session subscriptions</done>
</task>

<task type="auto">
  <name>Task 2: Create HttpAdapter implementing WebElectronAPI</name>
  <files>
    apps/web/src/client/adapters/http-adapter.ts
    apps/web/src/client/adapters/index.ts
  </files>
  <action>
Create the HTTP adapter that implements the WebElectronAPI interface:

1. **apps/web/src/client/adapters/http-adapter.ts**:
   - Import WebElectronAPI, SessionEvent from '../types'
   - Import WebSocketManager from './websocket-manager'

   - Class HttpAdapter implements WebElectronAPI:
     - Private ws: WebSocketManager
     - Private baseUrl: string (default '')
     - Constructor(baseUrl = ''): Initialize ws = new WebSocketManager(), store baseUrl
     - connect(): void - Call this.ws.connect()

   **Session Methods:**
   - getSessions(): fetch GET /api/sessions, return json()
   - getSessionMessages(sessionId): fetch GET /api/sessions/{sessionId}, return null on 404, json() otherwise
   - createSession(workspaceId, options?): fetch POST /api/sessions with body { workspaceId, ...options }, return json()
   - deleteSession(sessionId): fetch DELETE /api/sessions/{sessionId}, return void
   - sendMessage(sessionId, message, attachments?, storedAttachments?, options?): fetch POST /api/sessions/{sessionId}/messages with body, returns void (202 Accepted)
   - cancelProcessing(sessionId, silent?): fetch POST /api/sessions/{sessionId}/abort with body { silent }, return void
   - respondToPermission(sessionId, requestId, allowed, alwaysAllow): Call ws.respondToPermission(), return true

   **Workspace Methods:**
   - getWorkspaces(): fetch GET /api/workspaces, return json()
   - createWorkspace(folderPath, name): fetch POST /api/workspaces with body { folderPath, name }, return json()

   **Config Methods:**
   - getApiSetup(): fetch GET /api/config/api-setup, return json()
   - updateApiSetup(authType, credential?, anthropicBaseUrl?, customModel?): fetch PATCH /api/config/api-setup with body
   - getModel(): fetch GET /api/config/model, return json().model (can be null)
   - setModel(model): fetch PATCH /api/config/model with body { model }
   - readPreferences(): fetch GET /api/config/preferences, return json()
   - writePreferences(content): fetch PUT /api/config/preferences with body { content }

   **Theme Methods:**
   - getColorTheme(): fetch GET /api/theme/color, return json().themeId
   - setColorTheme(themeId): fetch PUT /api/theme/color with body { themeId }
   - loadPresetThemes(): fetch GET /api/theme/presets, return json().presets or []
   - getAppTheme(): fetch GET /api/theme, return json() or null

   **Event Methods:**
   - onSessionEvent(callback): return this.ws.subscribe(callback)
   - subscribeToSession(sessionId): this.ws.subscribeToSession(sessionId)
   - unsubscribeFromSession(sessionId): this.ws.unsubscribeFromSession(sessionId)

   **Helper Methods (private):**
   - async fetch(path, options?): Wrapper that adds baseUrl, throws on non-ok response

   Export: export class HttpAdapter

2. **apps/web/src/client/adapters/index.ts** - Barrel export:
   - export { HttpAdapter } from './http-adapter'
   - export { WebSocketManager } from './websocket-manager'
  </action>
  <verify>
Run `bun run typecheck 2>&1 | grep -E "^apps/web"` - No type errors.
Verify HttpAdapter exports: `grep -n "export class HttpAdapter" apps/web/src/client/adapters/http-adapter.ts`
  </verify>
  <done>HttpAdapter class implements WebElectronAPI with fetch calls to all API endpoints, delegates events to WebSocketManager</done>
</task>

<task type="auto">
  <name>Task 3: Verify adapter integration with existing server</name>
  <files>
    apps/web/src/client/adapters/http-adapter.ts
  </files>
  <action>
Verify the adapter integrates correctly with the server:

1. Start the dev server: `bun run web:dev &` (background)

2. Test session endpoints match adapter expectations:
   - `curl http://localhost:3000/api/sessions` should return JSON array
   - `curl http://localhost:3000/api/workspaces` should return JSON array
   - `curl http://localhost:3000/api/config/api-setup` should return JSON with authType
   - `curl http://localhost:3000/api/theme/color` should return JSON with themeId

3. Test WebSocket connection:
   - Use websocat or node script to verify /ws accepts connections
   - Verify subscribe message format accepted: `{"type":"subscribe","sessionId":"test"}`

4. If any endpoint returns unexpected format, update HttpAdapter to handle it:
   - Wrap responses that return { data: [...] } pattern
   - Handle 404s returning null instead of throwing
   - Ensure error messages include status code

5. Kill dev server: `pkill -f "bun run web:dev"` or `kill %1`

No file changes needed if endpoints match; document any required adjustments.
  </action>
  <verify>
Server starts without errors: `bun run web:dev` shows "Server listening"
Endpoints return expected JSON structure
HttpAdapter fetch calls would succeed against these endpoints
  </verify>
  <done>HttpAdapter methods verified to match server API response formats, any discrepancies addressed</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Type Safety:**
   ```bash
   bun run typecheck 2>&1 | grep -E "^apps/web" | grep -v "packages/"
   # Should show no errors for apps/web files
   ```

2. **File Structure:**
   ```bash
   ls -la apps/web/src/client/adapters/
   ls -la apps/web/src/client/types/
   # Both directories should exist with expected files
   ```

3. **Exports:**
   ```bash
   grep "export" apps/web/src/client/adapters/index.ts
   grep "export" apps/web/src/client/types/index.ts
   # Both should export their modules
   ```
</verification>

<success_criteria>
- HttpAdapter class exists with methods for sessions, workspaces, config, theme
- WebSocketManager class handles connection, reconnection, and event routing
- WebElectronAPI type defines the subset of ElectronAPI supported on web
- All fetch calls use correct HTTP methods (GET, POST, PATCH, PUT, DELETE)
- WebSocket messages match server schema (subscribe, unsubscribe, permission_response)
- TypeScript compiles without errors in apps/web
</success_criteria>

<output>
After completion, create `.planning/phases/06-frontend-adaptation/06-01-SUMMARY.md`
</output>
