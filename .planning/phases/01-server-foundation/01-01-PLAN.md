---
phase: 01-server-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/package.json
  - apps/web/tsconfig.json
  - apps/web/src/server/index.ts
  - apps/web/src/server/lib/config.ts
  - apps/web/src/server/lib/shutdown.ts
  - apps/web/src/server/plugins/websocket.ts
autonomous: true

must_haves:
  truths:
    - "Server starts and listens on configured port"
    - "WebSocket endpoint accepts connections"
    - "Server shuts down cleanly on SIGTERM/SIGINT"
  artifacts:
    - path: "apps/web/package.json"
      provides: "Web app dependencies and scripts"
      contains: "fastify"
    - path: "apps/web/src/server/index.ts"
      provides: "Server entry point"
      exports: ["createServer", "startServer"]
    - path: "apps/web/src/server/lib/config.ts"
      provides: "Server configuration"
      exports: ["getConfig", "ServerConfig"]
    - path: "apps/web/src/server/lib/shutdown.ts"
      provides: "Graceful shutdown handler"
      exports: ["setupGracefulShutdown"]
    - path: "apps/web/src/server/plugins/websocket.ts"
      provides: "WebSocket plugin"
      exports: ["websocketPlugin"]
  key_links:
    - from: "apps/web/src/server/index.ts"
      to: "apps/web/src/server/lib/config.ts"
      via: "import getConfig"
      pattern: "import.*config"
    - from: "apps/web/src/server/index.ts"
      to: "apps/web/src/server/plugins/websocket.ts"
      via: "fastify.register"
      pattern: "register.*websocketPlugin"
---

<objective>
Create the core Fastify server infrastructure with WebSocket support and graceful shutdown.

Purpose: Establishes the foundation for the web application server, replacing Electron's main process with a Node.js HTTP/WebSocket server.

Output: A running Fastify server that accepts WebSocket connections and handles SIGTERM/SIGINT gracefully.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-server-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create web app project structure with dependencies</name>
  <files>
    apps/web/package.json
    apps/web/tsconfig.json
    apps/web/src/server/lib/config.ts
  </files>
  <action>
Create the apps/web directory structure for the new web application:

1. Create `apps/web/package.json`:
   - name: "@craft-agent/web"
   - type: "module"
   - Dependencies: fastify@^5.7.0, @fastify/websocket@^11.2.0, @fastify/static@^8.0.0
   - DevDependencies: tsx, pino-pretty, @types/ws, @types/node
   - Scripts: "dev": "tsx watch src/server/index.ts", "start": "node dist/server/index.js"

2. Create `apps/web/tsconfig.json`:
   - Extend from root tsconfig if exists, otherwise standalone
   - Target ES2022, module NodeNext, moduleResolution NodeNext
   - Enable strict mode, esModuleInterop, skipLibCheck
   - Include src/**/*

3. Create `apps/web/src/server/lib/config.ts`:
   - Export interface `ServerConfig` with: port, host, isDev, staticRoot
   - Export function `getConfig()` that reads from environment:
     - PORT env var (default 3000)
     - HOST env var (default '0.0.0.0')
     - NODE_ENV for isDev detection
     - Static root path calculated from __dirname

Install dependencies after creating package.json:
```bash
cd apps/web && bun install
```
  </action>
  <verify>
Run: `ls apps/web/package.json apps/web/tsconfig.json apps/web/src/server/lib/config.ts`
All three files exist.
Run: `cd apps/web && bun run tsc --noEmit`
TypeScript compiles without errors.
  </verify>
  <done>
apps/web directory exists with package.json, tsconfig.json, and config.ts. Dependencies are installed. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Fastify server with graceful shutdown</name>
  <files>
    apps/web/src/server/index.ts
    apps/web/src/server/lib/shutdown.ts
  </files>
  <action>
1. Create `apps/web/src/server/lib/shutdown.ts`:
   - Export async function `setupGracefulShutdown(fastify: FastifyInstance): Promise<void>`
   - Listen for SIGTERM and SIGINT signals
   - On signal: log receipt, call `await fastify.close()`, log success, exit 0
   - On error during shutdown: log error, exit 1
   - Use pattern from RESEARCH.md

2. Create `apps/web/src/server/index.ts`:
   - Import Fastify, getConfig, setupGracefulShutdown
   - Export async function `createServer(config: ServerConfig): Promise<FastifyInstance>`
     - Create Fastify instance with pino logger
     - Configure logger: debug level in dev, info in prod
     - Use pino-pretty transport in dev mode only
     - Return the fastify instance (don't start yet)
   - Export async function `startServer(): Promise<void>`
     - Get config via getConfig()
     - Create server via createServer(config)
     - Setup graceful shutdown
     - Call fastify.listen({ port, host })
     - Log "Server listening on {host}:{port}"
   - If this file is run directly (not imported), call startServer()

Note: Do NOT register any plugins yet in createServer - that comes in Task 3.
  </action>
  <verify>
Run: `cd apps/web && bun run src/server/index.ts &`
Wait 2 seconds, then: `curl -s http://localhost:3000 || echo "expected 404"`
Server should respond (404 is expected since no routes yet).
Kill with: `pkill -f "bun run src/server/index.ts"` or Ctrl+C
Verify "Received shutdown signal" appears in logs.
  </verify>
  <done>
Server starts on port 3000, responds to HTTP requests, and shuts down cleanly on SIGTERM.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create WebSocket plugin with connection management</name>
  <files>
    apps/web/src/server/plugins/websocket.ts
    apps/web/src/server/index.ts (update)
  </files>
  <action>
1. Create `apps/web/src/server/plugins/websocket.ts`:
   - Import fastifyWebsocket from '@fastify/websocket'
   - Import type WebSocket from 'ws'
   - Import fp from 'fastify-plugin' for proper encapsulation
   - Create a Set to track active WebSocket clients
   - Export the plugin wrapped with fastify-plugin:
     - Register @fastify/websocket with maxPayload: 1048576 (1MB)
     - Create route GET '/ws' with { websocket: true }
     - On connection:
       - Add socket to clients Set
       - Log "WebSocket client connected"
       - Send JSON acknowledgment: { type: 'connected', timestamp: Date.now() }
     - On 'close':
       - Remove socket from clients Set
       - Log "WebSocket client disconnected"
     - On 'error':
       - Log error
       - Remove socket from clients Set
     - On 'message':
       - Parse JSON, log debug message (handlers come in Phase 3)
       - Wrap in try-catch for malformed messages
   - Decorate fastify with broadcast function for later use

2. Update `apps/web/src/server/index.ts`:
   - Import websocketPlugin from './plugins/websocket.ts'
   - In createServer(), after creating Fastify instance:
     - await fastify.register(websocketPlugin)

IMPORTANT: Attach 'message' handler synchronously (not in async callback) to avoid missing messages. See RESEARCH.md "WebSocket Handler Async Trap" pitfall.
  </action>
  <verify>
Run: `cd apps/web && bun run src/server/index.ts &`
Wait 2 seconds.
Test WebSocket connection with:
```bash
echo '{"type":"ping"}' | websocat ws://localhost:3000/ws
```
Or if websocat not available:
```bash
node -e "const ws = new (require('ws'))('ws://localhost:3000/ws'); ws.on('message', d => { console.log(d.toString()); ws.close(); }); ws.on('open', () => console.log('connected'));"
```
Should receive: {"type":"connected","timestamp":...}
Kill server after test.
  </verify>
  <done>
WebSocket endpoint at /ws accepts connections and sends acknowledgment. Connection tracking works. Server logs connections and disconnections.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Server starts:** `cd apps/web && bun run dev` starts server on port 3000
2. **WebSocket works:** Connect to ws://localhost:3000/ws, receive connection acknowledgment
3. **Graceful shutdown:** Send SIGTERM, server logs shutdown and exits cleanly
4. **TypeScript:** `bun run tsc --noEmit` passes with no errors

Requirements covered:
- SRVR-01: Fastify HTTP server starts and listens on configurable port
- SRVR-02: WebSocket server accepts connections and manages client lifecycle
- SRVR-05: Server gracefully shuts down on SIGTERM/SIGINT
</verification>

<success_criteria>
- Server starts with `bun run dev` in apps/web
- WebSocket connection to /ws returns {"type":"connected",...}
- SIGTERM causes clean shutdown with log messages
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-server-foundation/01-01-SUMMARY.md`
</output>
