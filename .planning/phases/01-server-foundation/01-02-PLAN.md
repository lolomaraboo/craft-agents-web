---
phase: 01-server-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - apps/web/src/server/plugins/static.ts
  - apps/web/src/server/index.ts
  - apps/web/vite.config.ts
  - apps/web/src/client/index.html
  - apps/web/src/client/main.tsx
  - apps/web/package.json
  - package.json
autonomous: true

must_haves:
  truths:
    - "Browser can load React app from server root URL"
    - "Frontend changes hot-reload in browser during development"
    - "API and WebSocket requests proxy to Fastify in dev mode"
  artifacts:
    - path: "apps/web/src/server/plugins/static.ts"
      provides: "Static file serving plugin"
      exports: ["staticPlugin"]
    - path: "apps/web/vite.config.ts"
      provides: "Vite development server config"
      contains: "proxy"
    - path: "apps/web/src/client/index.html"
      provides: "React app entry HTML"
      contains: "root"
    - path: "apps/web/src/client/main.tsx"
      provides: "React app entry point"
      contains: "createRoot"
  key_links:
    - from: "apps/web/vite.config.ts"
      to: "http://localhost:3000"
      via: "proxy configuration"
      pattern: "proxy.*localhost:3000"
    - from: "apps/web/src/server/plugins/static.ts"
      to: "apps/web/dist/client"
      via: "@fastify/static root"
      pattern: "root.*dist"
---

<objective>
Add static file serving for production and Vite dev server integration for development hot reload.

Purpose: Enables the React application to be served from the Fastify server in production, while providing fast hot-reload development experience via Vite.

Output: Complete development workflow where `bun run dev` starts both backend and frontend with hot reload, and production build serves static files from Fastify.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-server-foundation/01-RESEARCH.md
@.planning/phases/01-server-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create static file serving plugin with SPA fallback</name>
  <files>
    apps/web/src/server/plugins/static.ts
    apps/web/src/server/index.ts (update)
  </files>
  <action>
1. Create `apps/web/src/server/plugins/static.ts`:
   - Import fastifyStatic from '@fastify/static'
   - Import fp from 'fastify-plugin'
   - Import path and fileURLToPath for __dirname calculation
   - Export plugin wrapped with fastify-plugin:
     - Accept options: { enabled: boolean } (skip in dev mode)
     - If not enabled, return early (no-op)
     - Register @fastify/static:
       - root: path.join(__dirname, '../../../dist/client')
       - prefix: '/'
       - wildcard: false (we handle fallback manually)
     - Set up SPA fallback with setNotFoundHandler:
       - Only for GET requests
       - Not for /api/* or /ws paths
       - Return reply.sendFile('index.html')
       - Otherwise return 404 JSON error

2. Update `apps/web/src/server/index.ts`:
   - Import staticPlugin from './plugins/static.ts'
   - In createServer(), after websocket plugin:
     - await fastify.register(staticPlugin, { enabled: !config.isDev })
   - In dev mode, the plugin does nothing (Vite handles frontend)
   - In production mode, serves static files from dist/client

Note: Static plugin must be registered AFTER websocket plugin so WebSocket routes take precedence.
  </action>
  <verify>
Run: `cd apps/web && bun run tsc --noEmit`
TypeScript compiles without errors.
Check that static plugin is imported in index.ts.
  </verify>
  <done>
Static plugin created with SPA fallback. Plugin skips registration in dev mode. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create minimal React app and Vite configuration</name>
  <files>
    apps/web/vite.config.ts
    apps/web/src/client/index.html
    apps/web/src/client/main.tsx
    apps/web/src/client/App.tsx
    apps/web/package.json (update)
  </files>
  <action>
1. Update `apps/web/package.json`:
   - Add devDependencies: vite, @vitejs/plugin-react, react, react-dom, @types/react, @types/react-dom
   - Add scripts:
     - "dev:server": "tsx watch src/server/index.ts"
     - "dev:client": "vite"
     - "dev": "concurrently \"bun run dev:server\" \"bun run dev:client\""
     - "build:client": "vite build"
     - "build": "bun run build:client && bun run tsc -p tsconfig.server.json"
     - "preview": "NODE_ENV=production bun run src/server/index.ts"
   - Add devDependency: concurrently (for running both servers)

2. Create `apps/web/vite.config.ts`:
   - Import defineConfig from 'vite' and react from '@vitejs/plugin-react'
   - Configure:
     - plugins: [react()]
     - root: 'src/client'
     - build.outDir: '../../dist/client'
     - build.emptyOutDir: true
     - server.port: 5173
     - server.proxy:
       - '/api': { target: 'http://localhost:3000', changeOrigin: true }
       - '/ws': { target: 'ws://localhost:3000', ws: true }

3. Create `apps/web/src/client/index.html`:
   - Standard HTML5 boilerplate
   - div#root for React mount point
   - script type="module" src="/main.tsx"

4. Create `apps/web/src/client/main.tsx`:
   - Import React, createRoot from 'react-dom/client'
   - Import App from './App'
   - Render App to #root

5. Create `apps/web/src/client/App.tsx`:
   - Simple functional component
   - Display: "Craft Agents Web" heading
   - Show connection status placeholder
   - Add a button that tests WebSocket connection (logs to console)

Run `cd apps/web && bun install` after updating package.json.
  </action>
  <verify>
Run: `cd apps/web && bun run dev:client &`
Wait 3 seconds.
Run: `curl -s http://localhost:5173 | grep -o "Craft Agents"`
Should output "Craft Agents".
Kill vite process.
  </verify>
  <done>
Vite config created with proxy to Fastify. Minimal React app renders. Dev client starts on port 5173.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add root-level dev script and verify full workflow</name>
  <files>
    package.json (root)
    apps/web/tsconfig.server.json
  </files>
  <action>
1. Create `apps/web/tsconfig.server.json`:
   - Extend from ./tsconfig.json
   - Include only src/server/**/*
   - Exclude src/client
   - outDir: ./dist/server
   - For production build of server code

2. Update root `package.json`:
   - Add script: "web:dev": "cd apps/web && bun run dev"
   - Add script: "web:build": "cd apps/web && bun run build"
   - Add script: "web:preview": "cd apps/web && bun run preview"

3. Verify the complete development workflow:
   - Start: `bun run web:dev`
   - This should start both Fastify (port 3000) and Vite (port 5173)
   - Open http://localhost:5173 to see React app
   - WebSocket connections from frontend should proxy to Fastify
   - Frontend file changes should hot-reload
   - Backend file changes should restart server (tsx watch)
  </action>
  <verify>
Full workflow test:
1. Run: `bun run web:dev &`
2. Wait 5 seconds for both servers to start
3. Test frontend: `curl -s http://localhost:5173 | grep -o "Craft Agents"`
4. Test backend: `curl -s http://localhost:3000/ws 2>&1 | head -1` (should get upgrade required or similar)
5. Test proxy: `curl -s http://localhost:5173/api/health 2>&1` (404 expected, but shows proxy works)
6. Kill processes: `pkill -f "tsx watch" && pkill -f vite`
  </verify>
  <done>
Root-level scripts work. `bun run web:dev` starts full development environment. Proxy configuration routes /api and /ws to Fastify.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Static serving ready:** Static plugin registered (inactive in dev)
2. **Vite works:** `bun run web:dev` starts frontend with hot reload on port 5173
3. **Proxy works:** /api/* and /ws requests proxy from Vite to Fastify
4. **Full workflow:** Both servers start together via concurrently

Requirements covered:
- SRVR-03: Static file serving delivers React app bundle (production)
- SRVR-04: Development server supports hot reload for frontend changes

Combined with 01-01:
- All SRVR-01 through SRVR-05 requirements complete
</verification>

<success_criteria>
- `bun run web:dev` starts both Fastify and Vite
- http://localhost:5173 shows React app
- WebSocket proxy to Fastify works (testable via browser console)
- Frontend changes trigger hot reload (no page refresh needed)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-server-foundation/01-02-SUMMARY.md`
</output>
